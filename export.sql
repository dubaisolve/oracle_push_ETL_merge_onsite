--------------------------------------------------------
--  File created - Sunday-February-18-2024   
--------------------------------------------------------
--------------------------------------------------------
--  DDL for Sequence ACCOUNTINGGROUP_ACCOUNTINGGROU
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."ACCOUNTINGGROUP_ACCOUNTINGGROU"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence BOOKEDELEMENTS_BOOKEDELEMENTS_
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."BOOKEDELEMENTS_BOOKEDELEMENTS_"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 85554692 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence BOOKEDELEMENTTYPE_BOOKEDELEMEN
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."BOOKEDELEMENTTYPE_BOOKEDELEMEN"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence BOOKEDITEMSFLIGHTTICKET_TICKET
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."BOOKEDITEMSFLIGHTTICKET_TICKET"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 8979184 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence BOOKEDITEMSSTATUS_BOOKEDITEMSS
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."BOOKEDITEMSSTATUS_BOOKEDITEMSS"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence BOOKEDITEMS_BOOKINGITEMS_ID
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."BOOKEDITEMS_BOOKINGITEMS_ID"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 12361819 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence BOOKINGMETHOD_BOOKINGMETHOD_ID
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."BOOKINGMETHOD_BOOKINGMETHOD_ID"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence BOOKINGSOURCE_SOURCE_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."BOOKINGSOURCE_SOURCE_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence BOOKINGSTATUS_BOOKINGSTATUS_ID
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."BOOKINGSTATUS_BOOKINGSTATUS_ID"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence BOOKINGS_BOOKING_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."BOOKINGS_BOOKING_ID_SEQ"  MINVALUE 0 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 11215096 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence BOOKINGTYPE_BOOKINGTYPE_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."BOOKINGTYPE_BOOKINGTYPE_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 123 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence DOMAIN_DOMAIN_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."DOMAIN_DOMAIN_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence ESTABLISHMENTS_ESTAB_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."ESTABLISHMENTS_ESTAB_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence ITINCUSTOMER_ITINCUSTOMER_ID
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."ITINCUSTOMER_ITINCUSTOMER_ID"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 48398 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence ITINERARIES_ITINERARIES_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."ITINERARIES_ITINERARIES_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 9510506 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence ITINERARYSTATUS_ITINERARYSTATU
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."ITINERARYSTATUS_ITINERARYSTATU"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence LOCALE_LOCALE_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."LOCALE_LOCALE_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence MARKETINGCHANNEL_MARKETINGCHAN
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."MARKETINGCHANNEL_MARKETINGCHAN"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence OFFICE_OFFICE_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."OFFICE_OFFICE_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1378 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence SEGMENTS_SEGMENTS_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."SEGMENTS_SEGMENTS_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 20336910 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence SEQ1
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."SEQ1"  MINVALUE 1 MAXVALUE 99999 INCREMENT BY 1 START WITH 81 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence SUPPLIER_SUPPLIER_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."SUPPLIER_SUPPLIER_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 6564 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence TRAVELAGENT_TRAVELAGENT_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."TRAVELAGENT_TRAVELAGENT_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1203 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence TRAVELLERS_TRAVELLERS_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."TRAVELLERS_TRAVELLERS_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 33819707 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence USERS_USER_ID_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "BI_PROTAS"."USERS_USER_ID_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 5833 NOCACHE  ORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
-- Unable to render TABLE DDL for object BI_TRAVELBOX_USER.UPDATE_LOG with DBMS_METADATA attempting internal generator.
CREATE TABLE BI_TRAVELBOX_USER.UPDATE_LOG 
(
  STEP VARCHAR2(100 BYTE) 
, STARTTIME TIMESTAMP(6) 
, ENDTIME TIMESTAMP(6) 
, JOBNAME VARCHAR2(100 BYTE) 
, ROWSUPDATED NUMBER 
) 
LOGGING 
TABLESPACE BI_TRAVELBOX 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NO INMEMORY 
NOPARALLEL
-- Unable to render TABLE DDL for object BI_TRAVELBOX_USER.BOOKEDITEMS with DBMS_METADATA attempting internal generator.
COMMENT ON TABLE BI_TRAVELBOX_USER.BOOKEDITEMS IS 'Distinct itemsrelated to a quote/booking'CREATE TABLE BI_TRAVELBOX_USER.BOOKEDITEMS 
(
  BOOKINGITEMS_ID NUMBER(28, 0) 
, SRCSYSBOOKEDITEMID VARCHAR2(40 CHAR) 
, BOOKING_ID NUMBER(28, 0) 
, CREATEDDATE DATE 
, LASTUPDATED DATE 
, BOOKEDITEMSSTATUS_ID NUMBER(*, 0) 
, USER_ID NUMBER(*, 0) 
, SUPPLIERBOOKINGREF NVARCHAR2(100) 
, SUPPLIER_ID NUMBER(*, 0) 
, TBX_BKG_ID NUMBER 
, PRODUCT_CODE VARCHAR2(7 BYTE) 
, ITEM_NO NUMBER 
, CONTRACT_ID NUMBER 
, MANUAL_ITEM NUMBER 
, FLAG TIMESTAMP(6) 
) 
NOLOGGING 
TABLESPACE BI_TRAVELBOX 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NO INMEMORY 
NOPARALLELCOMMENT ON COLUMN BI_TRAVELBOX_USER.BOOKEDITEMS.SRCSYSBOOKEDITEMID IS 'connecting field used to connect between dFO and TAS tables. testing stage.';
COMMENT ON COLUMN BI_TRAVELBOX_USER.BOOKEDITEMS.BOOKING_ID IS 'unique identifier of an individual product or service of a booking (in the internal business intelligence data model) that is booked in an itinerary.';
COMMENT ON COLUMN BI_TRAVELBOX_USER.BOOKEDITEMS.CREATEDDATE IS 'In an existing itinerary, if any product or service is added at a later date than the booked date, then this attribute will capture the date when the product or service was added.
';
COMMENT ON COLUMN BI_TRAVELBOX_USER.BOOKEDITEMS.LASTUPDATED IS 'In an existing itinerary, if any product or service is added / modified / cancelled, then this attribute will capture the date when the product or service was added / modified / cancelled.
';
-- Unable to render TABLE DDL for object BI_TRAVELBOX_USER.BOOKINGS with DBMS_METADATA attempting internal generator.
COMMENT ON TABLE BI_TRAVELBOX_USER.BOOKINGS IS 'All distinct products/services quoted/booked with status'CREATE TABLE BI_TRAVELBOX_USER.BOOKINGS 
(
  BOOKING_ID NUMBER(28, 0) 
, ITINERARIES_ID NUMBER(*, 0) 
, SRCSYSITINID VARCHAR2(40 CHAR) 
, SRCSYSBOOKINGID VARCHAR2(40 CHAR) 
, BOOKINGDESCRIPTION VARCHAR2(1000 BYTE) 
, CREATEDDATE DATE 
, UPDATEDDATE DATE 
, BOOKINGSTATUS_ID NUMBER(*, 0) 
, USER_ID NUMBER(*, 0) 
, BOOKINGTYPE_ID NUMBER(*, 0) 
, TBX_BKG_ID NUMBER(*, 0) 
, PRODUCT_CODE VARCHAR2(7 BYTE) 
, ITEM_NO NUMBER 
, FLAG TIMESTAMP(6) 
) 
NOLOGGING 
TABLESPACE BI_TRAVELBOX 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NO INMEMORY 
NOPARALLELCOMMENT ON COLUMN BI_TRAVELBOX_USER.BOOKINGS.SRCSYSITINID IS 'unique identifier for an itinerary / trip in the source system in which it was booked. For e.g. Trip Id in dFO, Itinerary ID in TravelBox etc.
';
COMMENT ON COLUMN BI_TRAVELBOX_USER.BOOKINGS.SRCSYSBOOKINGID IS 'source system booking id';
COMMENT ON COLUMN BI_TRAVELBOX_USER.BOOKINGS.BOOKINGDESCRIPTION IS 'This attribute provides details with respect to a particular booking.
';
COMMENT ON COLUMN BI_TRAVELBOX_USER.BOOKINGS.CREATEDDATE IS 'In an existing itinerary, if any product or service is added at a later date than the booked date, then this attribute will capture the date when the product or service was added.
';
COMMENT ON COLUMN BI_TRAVELBOX_USER.BOOKINGS.UPDATEDDATE IS 'In an existing itinerary, if any product or service is added / modified / cancelled, then this attribute will capture the date when the product or service was added / modified / cancelled.
';
-- Unable to render TABLE DDL for object BI_TRAVELBOX_USER.ITINERARIES with DBMS_METADATA attempting internal generator.
COMMENT ON TABLE BI_TRAVELBOX_USER.ITINERARIES IS 'Container table for the entire Itinerary/Trip/Bundle that is used to link all individual components together.'CREATE TABLE BI_TRAVELBOX_USER.ITINERARIES 
(
  ITINERARIES_ID NUMBER(*, 0) 
, ITINCUSTOMER_ID NUMBER(*, 0) 
, OFFICE_ID NUMBER(*, 0) 
, USER_ID NUMBER(*, 0) 
, DOMAIN_ID NUMBER(*, 0) 
, TRAVELAGENT_ID NUMBER(*, 0) 
, BOOKINGMETHOD_ID NUMBER(*, 0) 
, ITINERARYSTATUS_ID NUMBER(*, 0) 
, MARKETINGCHANNEL_ID NUMBER(*, 0) 
, ACCOUNTINGGROUP_ID NUMBER(*, 0) 
, LOCALE_ID NUMBER(*, 0) 
, SOURCESYSTEM VARCHAR2(2 CHAR) 
, BOOKEDDATE DATE 
, FIRSTSERVICEDATE DATE 
, LASTSERVICEDATE DATE 
, PRIMARYDESTINATION VARCHAR2(70 CHAR) 
, SRCSYSITINID VARCHAR2(40 CHAR) 
, BOOKINGPAYMENTSTATUS_ID NUMBER(*, 0) 
, PROMOTION_ID NUMBER 
, EXT_BOOKING_ID VARCHAR2(100 BYTE) 
, FLAG TIMESTAMP(6) 
) 
NOLOGGING 
TABLESPACE BI_TRAVELBOX 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NO INMEMORY 
NOPARALLELCOMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.ITINERARIES_ID IS 'System Generated PK for Table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.ITINCUSTOMER_ID IS 'FK link to system generated PK ID from ItinCustomer table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.OFFICE_ID IS 'FK link to system generated PK ID from Office table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.USER_ID IS 'FK link to system generated PK ID from Users table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.DOMAIN_ID IS 'FK link to system generated PK ID from Domain Table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.TRAVELAGENT_ID IS 'FK link to system generated PK ID from TravelAgent table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.BOOKINGMETHOD_ID IS 'FK link to system generated PK ID from BookingMethod table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.ITINERARYSTATUS_ID IS 'FK link to system generated PK ID from ItineraryStatus table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.MARKETINGCHANNEL_ID IS 'FK link to system generated PK ID from MarketingChannel table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.ACCOUNTINGGROUP_ID IS 'FK link to system generated PK ID from AccountingGroup table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.LOCALE_ID IS 'FK link to system generated PK ID from Locale table';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.SOURCESYSTEM IS 'Two letter code for the Source System of the data
';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.BOOKEDDATE IS 'Date  when the booking was made.';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.FIRSTSERVICEDATE IS 'Earliest date of all the products and services booked in an itinerary.';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.LASTSERVICEDATE IS 'Last date of all the products and services booked in an itinerary.';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.PRIMARYDESTINATION IS 'Name of the primary destination in an itinerary.';
COMMENT ON COLUMN BI_TRAVELBOX_USER.ITINERARIES.SRCSYSITINID IS 'ID from Source System ';
-- Unable to render TABLE DDL for object BI_TRAVELBOX_USER.OFFICE with DBMS_METADATA attempting internal generator.
CREATE TABLE BI_TRAVELBOX_USER.OFFICE 
(
  OFFICE_ID NUMBER(*, 0) 
, OFFNAME VARCHAR2(50 BYTE) 
, SRCSYSOFFICEID VARCHAR2(40 CHAR) 
, FLAG TIMESTAMP(6) 
) 
NOLOGGING 
TABLESPACE BI_TRAVELBOX 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NO INMEMORY 
NOPARALLEL
-- Unable to render TABLE DDL for object BI_TRAVELBOX_USER.TABLESLOADORDER with DBMS_METADATA attempting internal generator.
CREATE TABLE BI_TRAVELBOX_USER.TABLESLOADORDER 
(
  TABLE_NAME VARCHAR2(70 BYTE) 
, ORDER_NO NUMBER(2, 0) 
, TABLE_TYPE VARCHAR2(50 BYTE) 
, PROC_NAME VARCHAR2(70 BYTE) 
) 
LOGGING 
TABLESPACE BI_TRAVELBOX 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NO INMEMORY 
NOPARALLEL
-- Unable to render TABLE DDL for object BI_TRAVELBOX_USER.TRAVELLERS with DBMS_METADATA attempting internal generator.
CREATE TABLE BI_TRAVELBOX_USER.TRAVELLERS 
(
  TRAVELLERS_ID NUMBER(20, 0) 
, ITINERARIES_ID NUMBER(*, 0) 
, SRCSYSITINID VARCHAR2(40 CHAR) 
, SRCSYSBOOKINGID VARCHAR2(40 CHAR) 
, SALUTATION VARCHAR2(40 CHAR) 
, FIRSTNAME VARCHAR2(70 BYTE) 
, LASTNAME VARCHAR2(70 BYTE) 
, PAXTYPE VARCHAR2(12 CHAR) 
, PAXAGE NUMBER(4, 0) 
, GENDER VARCHAR2(2 BYTE) 
, DOB DATE 
, LEADPASSENGER VARCHAR2(2 BYTE) 
, NATIONALITYCODE VARCHAR2(3 CHAR) 
, SRCSYSPASSID VARCHAR2(40 CHAR) 
, PASSPORTNO NVARCHAR2(50) 
, PASSENGER_NO NUMBER(*, 0) 
, FLAG TIMESTAMP(6) 
) 
NOLOGGING 
TABLESPACE BI_TRAVELBOX 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NO INMEMORY 
NOPARALLEL
-- Unable to render TABLE DDL for object BI_TRAVELBOX_USER.USERS with DBMS_METADATA attempting internal generator.
CREATE TABLE BI_TRAVELBOX_USER.USERS 
(
  USER_ID NUMBER(*, 0) 
, USERNAME NVARCHAR2(60) 
, SRCSYSUSERID VARCHAR2(40 CHAR) 
, FLAG TIMESTAMP(6) 
) 
NOLOGGING 
TABLESPACE BI_TRAVELBOX 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NO INMEMORY 
NOPARALLEL
-- Unable to render TABLE DDL for object BI_TRAVELBOX_USER.SUPPLIER with DBMS_METADATA attempting internal generator.
CREATE TABLE BI_TRAVELBOX_USER.SUPPLIER 
(
  SUPPLIER_ID NUMBER(*, 0) 
, SRCSYSSUPPLIERID NVARCHAR2(40) 
, SUPPLIERNAME NVARCHAR2(200) 
, FLAG TIMESTAMP(6) 
) 
NOLOGGING 
TABLESPACE BI_TRAVELBOX 
PCTFREE 10 
INITRANS 1 
STORAGE 
( 
  INITIAL 65536 
  NEXT 1048576 
  MINEXTENTS 1 
  MAXEXTENTS UNLIMITED 
  BUFFER_POOL DEFAULT 
) 
NOCOMPRESS 
NO INMEMORY 
NOPARALLEL
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.BOOKEDITEMSLOAD with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.BOOKEDITEMSLOAD AS

          v_jobname         VARCHAR2(255) := 'Updating_containers';
          v_step            NVARCHAR2(100);
          v_starttime       TIMESTAMP;
          v_endtime         TIMESTAMP;
          l_rows_affected   NUMBER(
                    10
                  , 0
          );
BEGIN
          v_step := 'BOOKEDITEMS';
          v_starttime := systimestamp;
          MERGE /*+ append */ INTO bookeditems dst USING
                    ( SELECT
                              b.srcsysbookingid AS srcsysbookeditemid
                            , b.booking_id
                            , rbi.booked_date AS createddate
                            , rbi.last_modified_time AS lastupdated
                            , bis.bookeditemsstatus_id
                            , u.user_id
                            , REPLACE(REPLACE( replace(rbi.supplier_res_ref,'|'),  CHR(10) ), CHR(13) )  AS supplierbookingref
                            , s.supplier_id
                            , rbi.booking_id AS tbx_bkg_id
                            , rbi.product_code
                            , rbi.item_no
                            , rbi.CONTRACT_ID
                            , rbi.MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_booking_item rbi
                              LEFT JOIN bookings b ON
                                        b.tbx_bkg_id = rbi.booking_id
                              AND b.item_no = rbi.item_no
                              AND b.product_code = rbi.product_code
                              LEFT JOIN bookeditemsstatus bis ON bis.srcsysbookeditemstatid = rbi.booking_status
                              LEFT JOIN users u ON u.srcsysuserid = rbi.booked_user
                              LEFT JOIN supplier s ON s.srcsyssupplierid = rbi.supplier_id

----------------------------------------------- discounts inserts
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'TD'
                               || discount_no AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'tour_discount' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_tour_discount
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'AD'
                               || discount_no AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'accom_discount' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_accom_discount
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'GD'
                               || discount_no AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'generic_discount' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_generic_discount
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'CD'
                               || discount_no AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'car_discount' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_car_discount
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'BID'
                               || index_no AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'booking_item_discount' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_booking_item_discount

-----------------------------------------------suppliments insert
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'AS'
                               || supplement_no AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'accom_supplement' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_accom_supplement
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'TS'
                               || supplement_no AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'tour_supplement' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_tour_supplement
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'GS'
                               || supplement_no AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'generic_supplement' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_generic_supplement
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'CS'
                               || supplement_no AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'car_supplement' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_car_supplement
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'TES'
                               || supplement_no AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'trs_exc_supplement' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_trs_exc_supplement
                    UNION
                    SELECT
                              booking_id
                               || product_code
                               || item_no
                               || 'BIS'
                               || suppliment_id AS srcsysbookeditemid
                            , NULL booking_id
                            , NULL createddate
                            , NULL lastupdated
                            , NULL bookeditemsstatus_id
                            , NULL user_id
                            , 'booking_item_suppliment' supplierbookingref
                            , NULL supplier_id
                            , booking_id AS tbx_bkg_id
                            , product_code
                            , item_no
                            , null CONTRACT_ID
                            , null MANUAL_ITEM
                            , v_starttime AS flag
                    FROM
                              tbx.res_booking_item_suppliment
                    )
          src ON (
                    dst.srcsysbookeditemid = src.srcsysbookeditemid
          ) WHEN MATCHED THEN
                    UPDATE
          SET dst.booking_id = src.booking_id
                    , dst.createddate = src.createddate
                    , dst.lastupdated = src.lastupdated
                    , dst.bookeditemsstatus_id = src.bookeditemsstatus_id
                    , dst.user_id = src.user_id
                    , dst.supplierbookingref = src.supplierbookingref
                    , dst.supplier_id = src.supplier_id
                    , dst.tbx_bkg_id = src.tbx_bkg_id
                    , dst.product_code = src.product_code
                    , dst.item_no = src.item_no 
                    , dst.CONTRACT_ID = src.CONTRACT_ID
                    , dst.MANUAL_ITEM = src.MANUAL_ITEM
                    , dst.flag = src.flag
          WHERE
                              nvl(
                                        dst.booking_id
                                      , 0
                              ) != src.booking_id
                    OR nvl(
                                        dst.createddate
                                      , '01-Jan-55'
                              ) != src.createddate
                    OR nvl(
                                        dst.lastupdated
                                      , '01-Jan-55'
                              ) != src.lastupdated
                    OR nvl(
                                        dst.bookeditemsstatus_id
                                      , 0
                              ) != src.bookeditemsstatus_id
                    OR nvl(
                                        dst.user_id
                                      , 0
                              ) != src.user_id
                    OR nvl(
                                        dst.supplierbookingref
                                      , 0
                              ) != src.supplierbookingref
                    OR nvl(
                                        dst.supplier_id
                                      , 0
                              ) != src.supplier_id
                    OR nvl(
                                        dst.tbx_bkg_id
                                      , 0
                              ) != src.tbx_bkg_id
                    OR nvl(
                                        dst.product_code
                                      , 0
                              ) != src.product_code
                    OR nvl(
                                        dst.item_no
                                      , 0
                              ) != src.item_no
                    OR nvl(dst.CONTRACT_ID, 0) != src.CONTRACT_ID
                    OR nvl(dst.MANUAL_ITEM, '') != nvl(src.MANUAL_ITEM,'')
-- or nvl(dst.flag ,'01-JAN-81') != src.flag
          WHEN NOT MATCHED THEN INSERT ( srcsysbookeditemid, booking_id, createddate, lastupdated, bookeditemsstatus_id, user_id, supplierbookingref, supplier_id
, tbx_bkg_id, product_code, item_no, CONTRACT_ID, MANUAL_ITEM, flag ) VALUES ( src.srcsysbookeditemid, src.booking_id, src.createddate, src.lastupdated, src.bookeditemsstatus_id
, src.user_id, src.supplierbookingref, src.supplier_id, src.tbx_bkg_id, src.product_code, src.item_no, src.CONTRACT_ID, src.MANUAL_ITEM, src.flag );

          l_rows_affected := SQL%rowcount;
          v_endtime := systimestamp;
          COMMIT;
          INSERT INTO update_log (
                    step
                  , starttime
                  , endtime
                  , jobname
                  , rowsupdated
          ) VALUES (
                    v_step
                  , v_starttime
                  , v_endtime
                  , v_jobname
                  , l_rows_affected
          );

          COMMIT;
END;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.BOOKINGSLOAD with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.BOOKINGSLOAD AS

          v_jobname         VARCHAR2(255) := 'Updating_containers';
          v_step            NVARCHAR2(100);
          v_starttime       TIMESTAMP;
          v_endtime         TIMESTAMP;
          l_rows_affected   NUMBER(
                    10
                  , 0
          );
BEGIN
          v_step := 'BOOKINGS';
          v_starttime := systimestamp;
          MERGE INTO bookings dst USING
                    ( SELECT
                              iti.itineraries_id
                            , iti.srcsysitinid AS srcsysitinid                 --- was rbi.item_number --- fixed
                            , rbi.booking_id
                               || rbi.product_code
                               || rbi.item_no AS srcsysbookingid
                            , NULL AS bookingdescription
                            , rbi.booked_date AS createddate
                            , TO_CHAR(
                                        rbi.last_modified_time
                                      , 'DD-MON-YYYY'
                              ) AS updateddate
                            , bs.bookingstatus_id
                            , us.user_id
                            , bt.bookingtype_id
                            , rbi.booking_id AS tbx_bkg_id
                            , rbi.product_code
                            , rbi.item_no
                            , v_starttime AS flag
                    FROM
                              tbx.res_booking_item rbi
                              INNER JOIN itineraries iti ON iti.srcsysitinid = rbi.booking_id
                              LEFT JOIN bookingtype bt ON bt.srcsysbkgtypeid = rbi.product_code
                              LEFT JOIN bookingstatus bs ON bs.srcsysbkgstatid = rbi.booking_status
                              LEFT JOIN users us ON us.srcsysuserid = rbi.booked_user
--where rbi.booking_id in (750640)
                    )
          src ON (
                    dst.srcsysbookingid = src.srcsysbookingid
          ) WHEN MATCHED THEN
                    UPDATE
          SET dst.itineraries_id = src.itineraries_id
                    , dst.srcsysitinid = src.srcsysitinid
                    ,
                             --   dst.SrcSysBookingid = src.SrcSysBookingid,
                     dst.bookingdescription = src.bookingdescription
                    , dst.createddate = src.createddate
                    , dst.updateddate = src.updateddate
                    , dst.bookingstatus_id = src.bookingstatus_id
                    , dst.user_id = src.user_id
                    , dst.bookingtype_id = src.bookingtype_id
                    , dst.tbx_bkg_id = src.tbx_bkg_id
                    , dst.product_code = src.product_code
                    , dst.item_no = src.item_no
                    , dst.flag = src.flag
          WHERE
                              nvl(
                                        dst.itineraries_id
                                      , 0
                              ) != src.itineraries_id
                    OR nvl(
                                        dst.srcsysitinid
                                      , 0
                              ) != src.srcsysitinid
                    OR          --   nvl(dst.SrcSysBookingid = src.SrcSysBookingid or
                              nvl(
                                        dst.bookingdescription
                                      , 0
                              ) != src.bookingdescription
                    OR nvl(
                                        dst.createddate
                                      , '01-Jan-91'
                              ) != src.createddate
                    OR nvl(
                                        dst.updateddate
                                      , '01-Jan-91'
                              ) != src.updateddate
                    OR nvl(
                                        dst.bookingstatus_id
                                      , 0
                              ) != src.bookingstatus_id
                    OR nvl(
                                        dst.user_id
                                      , 0
                              ) != src.user_id
                    OR nvl(
                                        dst.bookingtype_id
                                      , 0
                              ) != src.bookingtype_id
                    OR nvl(
                                        dst.tbx_bkg_id
                                      , 0
                              ) != src.tbx_bkg_id
                    OR nvl(
                                        dst.product_code
                                      , 0
                              ) != src.product_code
                    OR nvl(
                                        dst.item_no
                                      , 0
                              ) != src.item_no
                                -- or nvl(dst.flag ,'01-JAN-81') != src.flag
          WHEN NOT MATCHED THEN INSERT ( itineraries_id, srcsysitinid, srcsysbookingid, bookingdescription, createddate, updateddate, bookingstatus_id,
 user_id, bookingtype_id, tbx_bkg_id, product_code, item_no, flag ) VALUES ( src.itineraries_id, src.srcsysitinid, src.srcsysbookingid, src.bookingdescription
, src.createddate, src.updateddate, src.bookingstatus_id, src.user_id, src.bookingtype_id, src.tbx_bkg_id, src.product_code, src.item_no,
 src.flag );

          l_rows_affected := SQL%rowcount;
          v_endtime := systimestamp;
          COMMIT;
          INSERT INTO update_log (
                    step
                  , starttime
                  , endtime
                  , jobname
                  , rowsupdated
          ) VALUES (
                    v_step
                  , v_starttime
                  , v_endtime
                  , v_jobname
                  , l_rows_affected
          );

          COMMIT;
END;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.GATHER_STATS_FOR_ALL_TB with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.GATHER_STATS_FOR_ALL_TB 
(
  schema_name in varchar2 
) as 

v_tablename        VARCHAR(50);

begin
FOR p IN (

          SELECT
                              table_name
                    FROM
                              (
                                        SELECT
                                                  proc_name
                                                , tablesloadorder.order_no
                                                , tablesloadorder.table_name
                                        FROM
                                                  tablesloadorder
                                                  INNER JOIN (
                                                            SELECT
                                                                      object_name
                                                            FROM
                                                                      user_procedures
                                                            WHERE
                                                                      object_type = 'PROCEDURE'
                                                  ) x ON x.object_name = tablesloadorder.proc_name
                                        ORDER BY tablesloadorder.order_no ASC
                              ) tot
          )
LOOP
begin 
  	  	DBMS_STATS.GATHER_TABLE_STATS (
  	  	  ownname => schema_name,
          tabname => p.table_name,
          estimate_percent => 100
          );
          end;
END LOOP;
end gather_stats_for_all_tb;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.GET_TBX_DUMP_BETWEEN with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.GET_TBX_DUMP_BETWEEN 
(
  from_d in varchar2 default '01-SEP-18' 
, to_d in varchar2 default '03-SEP-18'
)
AS
-- Name         : nikolaj.rybakov@dnata.com
-- Author       : Nikolai Rybakov
-- Description  :   Basic execution of CSV package export provided by ORACLE
--                  to dump files in csv format with designated separator.  
--                  
--                  Export directory needs to be set prior execution
--                  CREATE OR REPLACE DIRECTORY EXTRACT_DIR AS '/home/oracle/export'; p.s make shure physical path exist on server
--                  GRANT READ, WRITE ON DIRECTORY EXPORT TO OWNR;
--                  GRANT EXECUTE ON UTL_FILE TO OWNR;
--
-- Requirements : UTL_FILE, DBMS_SQL
-- Ammedments   :
--   When         Who                   What
--   ===========  ========              =================================================
--   04-APR-2018  Nikolaj Rybakov       Initial Creation
--   09-SEP-2018  Nikolaj Rybakov       Procedure Modified to get desired dump between dates for all tables in TBX_GDWH format
--

          v_dataentitycode   VARCHAR(2);
          v_datasourcecode   VARCHAR(2);
          v_tablename        VARCHAR(50);
          v_starttime        DATE;
          v_directoryname    VARCHAR(50);


BEGIN
          v_dataentitycode := 'BK';
          v_datasourcecode := 'TB';
          v_directoryname := 'EXPORT';  --- case sensitive
          v_starttime := SYSDATE;

--- add loop for execution of procs from loadigg order table
          FOR r IN (
                    SELECT
                              table_name
                    FROM
                              (
                                        SELECT
                                                  proc_name
                                                , tablesloadorder.order_no
                                                , tablesloadorder.table_name
                                        FROM
                                                  tablesloadorder
                                                  INNER JOIN (
                                                            SELECT
                                                                      object_name
                                                            FROM
                                                                      user_procedures
                                                            WHERE
                                                                      object_type = 'PROCEDURE'
                                                  ) x ON x.object_name = tablesloadorder.proc_name
                                        ORDER BY tablesloadorder.order_no ASC
                              ) tot
          ) LOOP
                     csv.generate(
                              v_directoryname
                            , v_dataentitycode||'_'||v_datasourcecode||'_'|| r.table_name||'_'||TO_DATE(v_starttime, 'DD-MON-YY')|| '.psv'
                            ,p_query=>'select * from '|| r.table_name || ' where cast(flag as date) between '||''''||from_d||''''||' and '||''''||to_d||''''
                            );

          END LOOP;
END;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.ITINERARIESLOAD with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.ITINERARIESLOAD AS

          v_jobname         VARCHAR2(255) := 'Updating_containers';
          v_step            NVARCHAR2(100);
          v_starttime       TIMESTAMP;
          v_endtime         TIMESTAMP;
          l_rows_affected   NUMBER(
                    10
                  , 0
          );
BEGIN
          v_step := 'ITINERARIES';
          v_starttime := systimestamp;
          MERGE /*+ APPEND */ INTO itineraries dst USING
                    ( SELECT
                              ic.itincustomer_id
                            , ofi.office_id
                            , us.user_id
                            , NULL AS domain_id
                            , ta.travelagent_id
                            , bm.bookingmethod_id
                            , itst.itinerarystatus_id
                            , ms.marketingchannel_id
                            , NULL AS accountinggroup_id
                            , loc.locale_id
                            , 'TB' AS sourcesystem
                            , TO_CHAR(
                                        res_booking.booking_date
                                      , 'DD-MON-YYYY'
                              ) AS bookeddate
                            , (
                                        SELECT
                                                  nvl(
                                                            TO_CHAR(
                                                                      MIN(from_DATE)
                                                                    , 'DD-MON-YYYY'
                                                            )
                                                          , res_booking.booking_date
                                                  )
                                        FROM
                                                  tbx.res_booking_item
                                        WHERE
                                                            booking_status IN (
                                                                      1000, 4000
                                                            )
                                                  AND booking_id = res_booking.booking_id
                              ) AS firstservicedate
                            , (
                                        SELECT
                                                  nvl(
                                                            TO_CHAR(
                                                                      MAX(TO_DATE)
                                                                    , 'DD-MON-YYYY'
                                                            )
                                                          , res_booking.booking_date
                                                  ) lastservicedate
                                        FROM
                                                  tbx.res_booking_item
                                        WHERE
                                                            booking_status IN (
                                                                      1000, 4000
                                                            )
                                                  AND booking_id = res_booking.booking_id
                              ) AS lastservicedate
                            , res_booking.destination AS primarydestination
                            , res_booking.booking_id AS srcsysitinid
                            , bps.bookingpaymentstatus_id
                            , res_booking.PROMOTION_ID
                            , REPLACE(REPLACE( replace(EXT_BOOKING_ID,'|'),  CHR(10) ), CHR(13) )  AS EXT_BOOKING_ID
                            , v_starttime AS flag
                    FROM
                              tbx.res_booking res_booking
       --   left join TBX.RES_PASSENGER rp on rp.booking_id = RES_BOOKING.BOOKING_ID
                              LEFT JOIN itincustomer ic ON ic.client_id = res_booking.client_id
                              LEFT JOIN marketingchannel ms ON ms.srcsysmrkchid = res_booking.division
                              LEFT JOIN office ofi ON ofi.srcsysofficeid = res_booking.company
                              LEFT JOIN locale loc ON loc.srcsyslocaleid = res_booking.locale
                              LEFT JOIN users us ON us.srcsysuserid = res_booking.booked_user
                              LEFT JOIN itinerarystatus itst ON itst.srcsysitinstatusid = res_booking.booking_status
                              LEFT JOIN travelagent ta ON ta.srcsystravelagentid = res_booking.client_id
                              LEFT JOIN bookingmethod bm ON bm.srcsysbookingmethodid = res_booking.distribution_channel
                              LEFT JOIN bookingpaymentstatus bps ON bps.srcsysbkgpaystatid = res_booking.option_status
                    )
          src ON (
                    dst.srcsysitinid = src.srcsysitinid
          ) WHEN MATCHED THEN
                    UPDATE
          SET dst.itincustomer_id = src.itincustomer_id
                    , dst.office_id = src.office_id
                    , dst.user_id = src.user_id
                    , dst.domain_id = src.domain_id
                    , dst.travelagent_id = src.travelagent_id
                    , dst.bookingmethod_id = src.bookingmethod_id
                    , dst.itinerarystatus_id = src.itinerarystatus_id
                    , dst.marketingchannel_id = src.marketingchannel_id
                    , dst.accountinggroup_id = src.accountinggroup_id
                    , dst.locale_id = src.locale_id
                    , dst.sourcesystem = src.sourcesystem
                    , dst.bookeddate = src.bookeddate
                    , dst.firstservicedate = src.firstservicedate
                    , dst.lastservicedate = src.lastservicedate
                    , dst.primarydestination = src.primarydestination
                    , dst.bookingpaymentstatus_id = src.bookingpaymentstatus_id
                    , dst.PROMOTION_ID = src.PROMOTION_ID
                    , dst.EXT_BOOKING_ID = src.EXT_BOOKING_ID
                    , dst.flag = src.flag
          WHERE
                              nvl(
                                        dst.itincustomer_id
                                      , 0
                              ) != src.itincustomer_id
                    OR nvl(
                                        dst.office_id
                                      , 0
                              ) != src.office_id
                    OR nvl(
                                        dst.user_id
                                      , 0
                              ) != src.user_id
                    OR nvl(
                                        dst.domain_id
                                      , 0
                              ) != src.domain_id
                    OR nvl(
                                        dst.travelagent_id
                                      , 0
                              ) != src.travelagent_id
                    OR nvl(
                                        dst.bookingmethod_id
                                      , 0
                              ) != src.bookingmethod_id
                    OR nvl(
                                        dst.itinerarystatus_id
                                      , 0
                              ) != src.itinerarystatus_id
                    OR nvl(
                                        dst.marketingchannel_id
                                      , 0
                              ) != src.marketingchannel_id
                    OR nvl(
                                        dst.accountinggroup_id
                                      , 0
                              ) != src.accountinggroup_id
                    OR nvl(
                                        dst.locale_id
                                      , 0
                              ) != src.locale_id
                    OR nvl(
                                        dst.sourcesystem
                                      , 0
                              ) != src.sourcesystem
                    OR nvl(
                                        dst.bookeddate
                                      , '01-Jan-91'
                              ) != src.bookeddate
                    OR nvl(
                                        dst.firstservicedate
                                      , '01-Jan-91'
                              ) != src.firstservicedate
                    OR nvl(
                                        dst.lastservicedate
                                      , '01-Jan-91'
                              ) != src.lastservicedate
                    OR nvl(
                                        dst.primarydestination
                                      , 0
                              ) != src.primarydestination
                    OR nvl(
                                        dst.bookingpaymentstatus_id
                                      , 0
                              ) != src.bookingpaymentstatus_id
                              OR nvl( dst.PROMOTION_ID , 0) != nvl(src.PROMOTION_ID,0) 
                               OR nvl( dst.EXT_BOOKING_ID , 0) != nvl(src.EXT_BOOKING_ID,0) 
                                -- or nvl(dst.flag ,'01-JAN-81') != src.flag 
          WHEN NOT MATCHED THEN INSERT ( itincustomer_id, office_id, user_id, domain_id, travelagent_id, bookingmethod_id, itinerarystatus_id, marketingchannel_id
, accountinggroup_id, locale_id, sourcesystem, bookeddate, firstservicedate, lastservicedate, primarydestination, srcsysitinid, bookingpaymentstatus_id
,PROMOTION_ID, EXT_BOOKING_ID, flag ) VALUES ( src.itincustomer_id, src.office_id, src.user_id, src.domain_id, src.travelagent_id, src.bookingmethod_id, src.itinerarystatus_id
, src.marketingchannel_id, src.accountinggroup_id, src.locale_id, src.sourcesystem, src.bookeddate, src.firstservicedate, src.lastservicedate
, src.primarydestination, src.srcsysitinid, src.bookingpaymentstatus_id, src.PROMOTION_ID, src.EXT_BOOKING_ID, src.flag );

          l_rows_affected := SQL%rowcount;
          v_endtime := systimestamp;
          COMMIT;
          INSERT INTO update_log (
                    step
                  , starttime
                  , endtime
                  , jobname
                  , rowsupdated
          ) VALUES (
                    v_step
                  , v_starttime
                  , v_endtime
                  , v_jobname
                  , l_rows_affected
          );

          COMMIT;
END;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.MERGE_EXPORT_ALL with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.MERGE_EXPORT_ALL AS
-- Name         : nikolaj.rybakov@dnata.com
-- Author       : Nikolai Rybakov
-- Description  :   Basic execution of CSV package export provided by ORACLE
--                  to dump files in csv format with designated separator.  
--                  
--                  Export directory needs to be set prior execution
--                  CREATE OR REPLACE DIRECTORY EXTRACT_DIR AS '/home/oracle/export'; p.s make shure physical path exist on server
--                  GRANT READ, WRITE ON DIRECTORY EXPORT TO OWNR;
--                  GRANT EXECUTE ON UTL_FILE TO OWNR;
--
-- Requirements : UTL_FILE, DBMS_SQL
-- Ammedments   :
--   When         Who                   What
--   ===========  ========              =================================================
--   04-APR-2018  Nikolaj Rybakov       Initial Creation
--   

          v_dataentitycode   VARCHAR(2);
          v_datasourcecode   VARCHAR(2);
          v_tablename        VARCHAR(50);
          v_starttime        DATE;
          v_directoryname    VARCHAR(50);
BEGIN
          v_dataentitycode := 'BK';
          v_datasourcecode := 'TB';
          v_directoryname := 'EXPORT';  --- case sensitive
          v_starttime := SYSDATE;

--- add loop for execution of procs from loadigg order table
          FOR p IN (
                    SELECT
                              proc_name
                    FROM
                              (
                                        SELECT
                                                  proc_name
                                                , tablesloadorder.order_no
                                                , tablesloadorder.table_name
                                        FROM
                                                  tablesloadorder
                                                  INNER JOIN (
                                                            SELECT
                                                                      object_name
                                                            FROM
                                                                      user_procedures
                                                            WHERE
                                                                      object_type = 'PROCEDURE'
                                                  ) x ON x.object_name = tablesloadorder.proc_name
                                        ORDER BY tablesloadorder.order_no ASC
                              ) tot
          ) LOOP
                    EXECUTE IMMEDIATE 'begin ' || p.proc_name || '; end;';
          END LOOP;

--- only export tables which where changed/merged

          FOR r IN (
                    SELECT
                              t.step AS table_name
                    FROM
                              update_log t
                              INNER JOIN (
                                        SELECT
                                                  ul.step AS table_name
                                                , MAX(ul.starttime) AS st
                                        FROM
                                                  update_log ul
                                        GROUP BY
                                                  ul.step
                              ) a ON
                                        t.step = a.table_name
                              AND t.starttime = a.st
                    WHERE
                              t.rowsupdated <> 0
          ) LOOP
                    csv.generate(
                              v_directoryname
                            , v_dataentitycode
                               || '_'
                               || v_datasourcecode
                               || '_'
                               || r.table_name
                               || '_'
                               || TO_DATE(
                                        v_starttime
                                      , 'DD-MON-YY'
                              )
                               || '.psv'
                            , p_query   => 'select * from '
                               || r.table_name
                               || ' where  flag >= (select max (starttime) from UPDATE_LOG where step = '
                               || ''''
                               || r.table_name
                               || ''''
                               || ')'
                    );
          END LOOP;

-- create daily log file of files exported by procedure above 

csv.generate('EXPORT', 'BK' || '_' || 'TB'|| '_'||'UPDATE_LOG'|| '_'|| TO_DATE(SYSDATE, 'DD-MON-YY')|| '.psv', p_query   => 'select * from update_log where starttime >= cast(trunc(current_timestamp) as timestamp) and rowsupdated <> 0');
csv.generate('EXPORT', 'BK' || '_' || 'TB'|| '_'||'UPDATE_LOG_SUM'|| '_'|| TO_DATE(SYSDATE, 'DD-MON-YY')|| '.psv', p_query   => 'select count(*) as cnt, sum(price) as smnt FROM bookedelements');
--once data is refreshed/synced and exported to psv files kick off sftp job but on different session so it is not held as a slave.

--          BEGIN
--                    dbms_scheduler.run_job(
--                              job_name              => 'SFTP_RUN'
--                            , use_current_session   => false
--                    );
--          END;
END merge_export_all;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.OFFICELOAD with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.OFFICELOAD AS

          v_jobname         VARCHAR2(255) := 'Master_table_update';
          v_step            NVARCHAR2(100);
          v_starttime       TIMESTAMP;
          v_endtime         TIMESTAMP;
          l_rows_affected   NUMBER(
                    10
                  , 0
          );
BEGIN
          v_step := 'OFFICE';
          v_starttime := systimestamp;
          MERGE INTO office dst USING
                    ( SELECT
                              code srcsysofficeid
                            , name offname
                            , v_starttime AS flag
                    FROM
                              tbx.cmp_company
                    )
          src ON (
                    dst.srcsysofficeid = src.srcsysofficeid
          ) WHEN MATCHED THEN
                    UPDATE
          SET  --dst.SrcSysOfficeId = src.SrcSysOfficeId,
           dst.offname = src.offname
                    , dst.flag = src.flag
          WHERE
                    nvl(
                              dst.offname
                            , 0
                    ) != src.offname
                             -- or nvl(dst.flag ,'01-JAN-81') != src.flag
          WHEN NOT MATCHED THEN INSERT ( srcsysofficeid, offname, flag ) VALUES ( src.srcsysofficeid, src.offname, src.flag );

          l_rows_affected := SQL%rowcount;
          v_endtime := systimestamp;
          COMMIT;
          INSERT INTO update_log (
                    step
                  , starttime
                  , endtime
                  , jobname
                  , rowsupdated
          ) VALUES (
                    v_step
                  , v_starttime
                  , v_endtime
                  , v_jobname
                  , l_rows_affected
          );

          COMMIT;
END;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.PROCEDURE1 with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.PROCEDURE1 
          AS
BEGIN
          FOR p IN (
                    SELECT
                              proc_name
                    FROM
                              (
                                        SELECT
                                                  proc_name
                                                , tablesloadorder.order_no
                                                , tablesloadorder.table_name
                                        FROM
                                                  tablesloadorder
                                                  INNER JOIN (
                                                            SELECT
                                                                      object_name
                                                            FROM
                                                                      user_procedures
                                                            WHERE
                                                                      object_type = 'PROCEDURE'
                                                  ) x ON x.object_name = tablesloadorder.proc_name
                                        ORDER BY tablesloadorder.order_no ASC
                              ) tot
          ) LOOP
                    EXECUTE IMMEDIATE 'begin ' || p.proc_name || '; end;';
          END LOOP;
END procedure1;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.PROCEDURE2 with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.PROCEDURE2 AS

          v_dataentitycode   VARCHAR(2);
          v_datasourcecode   VARCHAR(2);
          v_tablename        VARCHAR(50);
          v_starttime        DATE; --- change to time stamp for more frequesnt update if needed 
          v_directoryname    VARCHAR(50);
BEGIN
          v_dataentitycode := 'BK';
          v_datasourcecode := 'TB';
          v_directoryname := 'EXPORT';  --- case sensitive
          v_starttime := SYSDATE; -- change to systimestamp for more frequesnt update if needed
          FOR r IN (
                    SELECT
                              t.step AS table_name
                    FROM
                              update_log t
                              INNER JOIN (
                                        SELECT
                                                  ul.step AS table_name
                                                , MAX(ul.starttime) AS st
                                        FROM
                                                  update_log ul
                                        GROUP BY
                                                  ul.step
                              ) a ON
                                        t.step = a.table_name
                              AND t.starttime = a.st
                    WHERE
                              t.rowsupdated <> 0
          ) LOOP
                    csv.generate(
                              v_directoryname
                            , v_dataentitycode
                               || '_'
                               || v_datasourcecode
                               || '_'
                               || r.table_name
                               || '_'
                               || TO_DATE(
                                        v_starttime
                                      , 'DD-MON-YY'
                              )
                               || '.psv'
                            , p_query   => 'select * from '
                               || r.table_name
                               || ' where  flag >= (select max (starttime) from UPDATE_LOG where step = '
                               || ''''
                               || r.table_name
                               || ''''
                               || ')'
                    );
          END LOOP;

END procedure2;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.PROCEDURE_NAME_LOAD with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.PROCEDURE_NAME_LOAD AS

          v_jobname         VARCHAR2(255) := 'TABLE_NAME_CLASS';
          v_step            NVARCHAR2(100);
          v_starttime       TIMESTAMP;
          v_endtime         TIMESTAMP;
          l_rows_affected   NUMBER(10,0);
BEGIN
          v_step := 'PROCEDURE_NAME';
          v_starttime := systimestamp;
            MERGE INTO TABLE_you_are_merging_TO dst USING
(;

select * from tbx.ACT_BOOKING_ACTION;

)
 src ON   (
                    dst.supplier_id = src.supplier_id and dst.code = src.code
          ) 
          WHEN MATCHED THEN UPDATE
          SET  
           dst.code = src.code
          ,dst.value = src.value
          , dst.flag = src.flag
          WHERE
                    nvl(dst.code , 0 ) != src.code 
                    or nvl(dst.value ,0) != src.value

          WHEN NOT MATCHED THEN INSERT ( supplier_id, code,value, flag ) VALUES ( src.supplier_id, src.code,src.value, src.flag );

          l_rows_affected := SQL%rowcount;
          v_endtime := systimestamp;
          COMMIT;
          INSERT INTO update_log (
                    step
                  , starttime
                  , endtime
                  , jobname
                  , rowsupdated
          ) VALUES (
                    v_step
                  , v_starttime
                  , v_endtime
                  , v_jobname
                  , l_rows_affected
          );
          COMMIT;
END;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.SUPPLIERLOAD with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.SUPPLIERLOAD AS

          v_jobname         VARCHAR2(255) := 'Master_table_update';
          v_step            NVARCHAR2(100);
          v_starttime       TIMESTAMP;
          v_endtime         TIMESTAMP;
          l_rows_affected   NUMBER(
                    10
                  , 0
          );
BEGIN
          v_step := 'SUPPLIER';
          v_starttime := systimestamp;
          MERGE INTO supplier dst USING
                    ( SELECT
                              supplier_id srcsyssupplierid
                            , name suppliername
                            , v_starttime AS flag
                    FROM
                              tbx.supplier
                    )
          src ON (
                    dst.srcsyssupplierid = src.srcsyssupplierid
          ) WHEN MATCHED THEN
                    UPDATE
          SET  -- dst.SrcSysSupplierID = src.SrcSysSupplierID,
           dst.suppliername = src.suppliername
                    , dst.flag = src.flag
          WHERE
                    nvl(
                              dst.suppliername
                            , 0
                    ) != src.suppliername -- or nvl(dst.flag ,'01-JAN-81') != src.flag
          WHEN NOT MATCHED THEN INSERT ( srcsyssupplierid, suppliername, flag ) VALUES ( src.srcsyssupplierid, src.suppliername, src.flag );

          l_rows_affected := SQL%rowcount;
          v_endtime := systimestamp;
          COMMIT;
          INSERT INTO update_log (
                    step
                  , starttime
                  , endtime
                  , jobname
                  , rowsupdated
          ) VALUES (
                    v_step
                  , v_starttime
                  , v_endtime
                  , v_jobname
                  , l_rows_affected
          );

          COMMIT;
END;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.TRAVELLERSLOAD with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.TRAVELLERSLOAD AS

          v_jobname         VARCHAR2(255) := 'Updating_containers';
          v_step            NVARCHAR2(100);
          v_starttime       TIMESTAMP;
          v_endtime         TIMESTAMP;
          l_rows_affected   NUMBER(
                    10
                  , 0
          );
BEGIN
          v_step := 'TRAVELLERS';
          v_starttime := systimestamp;
          MERGE INTO travellers dst USING
                    ( SELECT
                              itin.itineraries_id
                            , itin.srcsysitinid
                            , res_passenger.booking_id AS srcsysbookingid
                            , cli_passenger_profile.title AS salutation
                            , Replace(REPLACE(REPLACE( cli_passenger_profile.first_name, CHR(10) ), CHR(13) ),chr(124)) AS firstname
                            , Replace(REPLACE(REPLACE( cli_passenger_profile.last_name, CHR(10) ), CHR(13) ),chr(124)) AS lastname
                            , res_passenger.type AS paxtype
                            , NULL AS paxage --- this will casue our merge to always merge cells// people get older and hance field us always updates based on sysdate. use in final DB: floor(months_between(SYSDATE, date_of_birth) / 12)
                            , cli_passenger_profile.sex AS gender
                            , TO_CHAR(
                                        cli_passenger_profile.date_of_birth
                                      , 'DD-MON-YY'
                              ) AS dob
                            , res_passenger.lead AS leadpassenger
                            , cli_passenger_profile.citizanship1 AS nationalitycode
                            , res_passenger.profile_id AS srcsyspassid    -------- no concept of passengers by distinct id so will 
               --   , res_passenger.passenger_no AS srcsyspassid
                            , cli_passenger_profile.primary_pp_no AS passportno
                            , res_passenger.passenger_no
              --    , ROW_NUMBER () OVER (PARTITION BY res_passenger.profile_id ORDER BY res_passenger.Passenger_no) as rownumber
                            , v_starttime AS flag
                    FROM
                              tbx.res_passenger res_passenger
                              INNER JOIN tbx.cli_passenger_profile cli_passenger_profile ON res_passenger.profile_id = cli_passenger_profile.profile_id
                              INNER JOIN itineraries itin ON itin.srcsysitinid = res_passenger.booking_id
                    )
          src ON (
                              dst.srcsyspassid = src.srcsyspassid
                    AND dst.srcsysbookingid = src.srcsysbookingid
          ) WHEN MATCHED THEN
                    UPDATE
          SET dst.itineraries_id = src.itineraries_id
                    , dst.srcsysitinid = src.srcsysitinid
       --   , dst.srcsysbookingid = src.srcsysbookingid
                    , dst.salutation = src.salutation
                    , dst.firstname = src.firstname
                    , dst.lastname = src.lastname
                    , dst.paxtype = src.paxtype
                    , dst.paxage = src.paxage
                    , dst.gender = src.gender
                    , dst.dob = src.dob
                    , dst.leadpassenger = src.leadpassenger
                    , dst.nationalitycode = src.nationalitycode
                    , dst.passportno = src.passportno
                    , dst.passenger_no = src.passenger_no
                    , dst.flag = src.flag
          WHERE
                              nvl(
                                        dst.itineraries_id
                                      , 0
                              ) != src.itineraries_id
                    OR nvl(
                                        dst.srcsysitinid
                                      , 0
                              ) != src.srcsysitinid
        --   or nvl(dst.srcsysbookingid  ,0) != src.srcsysbookingid
                    OR nvl(
                                        dst.salutation
                                      , 0
                              ) != src.salutation
                    OR nvl(
                                        dst.firstname
                                      , 0
                              ) != src.firstname
                    OR nvl(
                                        dst.lastname
                                      , 0
                              ) != src.lastname
                    OR nvl(
                                        dst.paxtype
                                      , 0
                              ) != src.paxtype
                    OR nvl(
                                        dst.paxage
                                      , 0
                              ) != src.paxage
                    OR nvl(
                                        dst.gender
                                      , 0
                              ) != src.gender
                    OR nvl(
                                        dst.dob
                                      , '01-Jan-21'
                              ) != src.dob
                    OR nvl(
                                        dst.leadpassenger
                                      , 0
                              ) != src.leadpassenger
                    OR nvl(
                                        dst.nationalitycode
                                      , 0
                              ) != src.nationalitycode
                    OR nvl(
                                        dst.passportno
                                      , 0
                              ) != src.passportno
                    OR nvl(
                                        dst.passenger_no
                                      , 0
                              ) != src.passenger_no
           -- or nvl(dst.flag ,'01-JAN-81') != src.flag
          WHEN NOT MATCHED THEN INSERT ( itineraries_id, srcsysitinid, srcsysbookingid, salutation, firstname, lastname, paxtype, paxage, gender, dob, leadpassenger
, nationalitycode, srcsyspassid, passportno, passenger_no, flag ) VALUES ( src.itineraries_id, src.srcsysitinid, src.srcsysbookingid, src.salutation
, src.firstname, src.lastname, src.paxtype, src.paxage, src.gender, src.dob, src.leadpassenger, src.nationalitycode, src.srcsyspassid, src.
passportno, src.passenger_no, src.flag );

          l_rows_affected := SQL%rowcount;
          v_endtime := systimestamp;
          COMMIT;
          INSERT INTO update_log (
                    step
                  , starttime
                  , endtime
                  , jobname
                  , rowsupdated
          ) VALUES (
                    v_step
                  , v_starttime
                  , v_endtime
                  , v_jobname
                  , l_rows_affected
          );

          COMMIT;
END;
-- Unable to render PROCEDURE DDL for object BI_TRAVELBOX_USER.USERSLOAD with DBMS_METADATA attempting internal generator.
CREATE PROCEDURE BI_TRAVELBOX_USER.USERSLOAD AS

          v_jobname         VARCHAR2(255) := 'Master_table_update';
          v_step            NVARCHAR2(100);
          v_starttime       TIMESTAMP;
          v_endtime         TIMESTAMP;
          l_rows_affected   NUMBER(
                    10
                  , 0
          );
BEGIN
          v_step := 'USERS';
          v_starttime := systimestamp;
          MERGE INTO users dst USING
                    ( SELECT
                              username
                            , user_id AS srcsysuserid
                            , v_starttime AS flag
                    FROM
                              tbx.adm_user
                    )
          src ON (
                    dst.srcsysuserid = src.srcsysuserid
          ) WHEN MATCHED THEN
                    UPDATE
          SET dst.username = src.username
                    , dst.flag = src.flag
          WHERE
                    nvl(
                              dst.username
                            , 0
                    ) != src.username
                                --or nvl(dst.flag ,'01-JAN-81') != src.flag -- uncoment to load full table every merge nonincrimental
          WHEN NOT MATCHED THEN INSERT ( username, srcsysuserid, flag ) VALUES ( src.username, src.srcsysuserid, src.flag );

          l_rows_affected := SQL%rowcount;
          v_endtime := systimestamp;
          COMMIT;
          INSERT INTO update_log (
                    step
                  , starttime
                  , endtime
                  , jobname
                  , rowsupdated
          ) VALUES (
                    v_step
                  , v_starttime
                  , v_endtime
                  , v_jobname
                  , l_rows_affected
          );

          COMMIT;
END;
-- Unable to render PACKAGE DDL for object BI_TRAVELBOX_USER.CSV with DBMS_METADATA attempting internal generator.
CREATE 
PACKAGE BI_TRAVELBOX_USER.CSV AS
-- --------------------------------------------------------------------------
-- Name         : https://oracle-base.com/dba/miscellaneous/cvs.sql
-- Author       : Tim Hall
-- Description  : Basic CSV API. For usage notes see:
--                  https://oracle-base.com/articles/9i/GeneratingCSVFiles.php
--
--                  CREATE OR REPLACE DIRECTORY dba_dir AS '/u01/app/oracle/dba/';
--                  ALTER SESSION SET NLS_DATE_FORMAT='DD-MON-YYYY HH24:MI:SS';
--
--                  EXEC csv.generate('DBA_DIR', 'generate.csv', p_query => 'SELECT * FROM emp');
--
-- Requirements : UTL_FILE, DBMS_SQL
-- Ammedments   :
--   When         Who       What
--   ===========  ========  =================================================
--   14-MAY-2005  Tim Hall  Initial Creation
--   19-MAY-2016  Tim Hall  Add REF CURSOR support.
-- --------------------------------------------------------------------------
          PROCEDURE generate (
                    p_dir     IN VARCHAR2
                  , p_file    IN VARCHAR2
                  , p_query   IN VARCHAR2
          );

          PROCEDURE generate_rc (
                    p_dir    IN VARCHAR2
                  , p_file   IN VARCHAR2
                  , p_refcursor IN OUT SYS_REFCURSOR );

          PROCEDURE set_separator ( p_sep   IN VARCHAR2 );

END csv;
-- Unable to render PACKAGE BODY DDL for object BI_TRAVELBOX_USER.CSV with DBMS_METADATA attempting internal generator.
CREATE 
PACKAGE BODY BI_TRAVELBOX_USER.CSV AS
-- --------------------------------------------------------------------------
-- Name         : https://oracle-base.com/dba/miscellaneous/cvs.sql
-- Author       : Tim Hall
-- Description  : Basic CSV API. For usage notes see:
--                  https://oracle-base.com/articles/9i/GeneratingCSVFiles.php
--
--                  CREATE OR REPLACE DIRECTORY dba_dir AS '/u01/app/oracle/dba/';
--                  ALTER SESSION SET NLS_DATE_FORMAT='DD-MON-YYYY HH24:MI:SS';
--
--                  -- Query
--                  EXEC csv.generate('DBA_DIR', 'generate.csv', p_query => 'SELECT * FROM emp');
--
--                  -- Ref Cursor
--                  DECLARE
--                    l_refcursor  SYS_REFCURSOR;
--                  BEGIN
--                    OPEN l_refcursor FOR --                      SELECT * FROM emp;
--                     
--                    csv.generate_rc('DBA_DIR','generate.csv', l_refcursor);
--                  END;
--                  /
--
--
-- Requirements : UTL_FILE, DBMS_SQL
-- Ammedments   :
--   When         Who       What
--   ===========  ========  =================================================
--   14-MAY-2005  Tim Hall  Initial Creation
--   19-MAY-2016  Tim Hall  Add REF CURSOR support.
-- --------------------------------------------------------------------------

          g_sep        VARCHAR2(5) := '|';

-- Prototype for hidden procedure.
          PROCEDURE generate_all (
                    p_dir     IN VARCHAR2
                  , p_file    IN VARCHAR2
                  , p_query   IN VARCHAR2
                  , p_refcursor IN OUT SYS_REFCURSOR );

-- Stub to generate a CSV from a query.

          PROCEDURE generate (
                    p_dir     IN VARCHAR2
                  , p_file    IN VARCHAR2
                  , p_query   IN VARCHAR2
          ) AS
                    l_cursor   SYS_REFCURSOR;
          BEGIN
                    generate_all(
                              p_dir         => p_dir
                            , p_file        => p_file
                            , p_query       => p_query
                            , p_refcursor   => l_cursor
                    );
          END generate;

-- Stub to generate a CVS from a REF CURSOR.

          PROCEDURE generate_rc (
                    p_dir    IN VARCHAR2
                  , p_file   IN VARCHAR2
                  , p_refcursor IN OUT SYS_REFCURSOR )
                    AS
          BEGIN
                    generate_all(
                              p_dir         => p_dir
                            , p_file        => p_file
                            , p_query       => NULL
                            , p_refcursor   => p_refcursor
                    );
          END generate_rc;

-- Do the actual work.

          PROCEDURE generate_all (
                    p_dir     IN VARCHAR2
                  , p_file    IN VARCHAR2
                  , p_query   IN VARCHAR2
                  , p_refcursor IN OUT SYS_REFCURSOR ) AS

                    l_cursor     PLS_INTEGER;
                    l_rows       PLS_INTEGER;
                    l_col_cnt    PLS_INTEGER;
                    l_desc_tab   dbms_sql.desc_tab;
                    l_buffer     VARCHAR2(32767);
                    l_file       utl_file.file_type;
          BEGIN
                    IF
                              p_query IS NOT NULL
                    THEN
                              l_cursor := dbms_sql.open_cursor;
                              dbms_sql.parse(
                                        l_cursor
                                      , p_query
                                      , dbms_sql.native
                              );
                    ELSIF p_refcursor%isopen THEN
                              l_cursor := dbms_sql.to_cursor_number(p_refcursor);
                    ELSE
                              raise_application_error(
                                        -20000
                                      , 'You must specify a query or a REF CURSOR.'
                              );
                    END IF;

                    dbms_sql.describe_columns(
                              l_cursor
                            , l_col_cnt
                            , l_desc_tab
                    );
                    FOR i IN 1..l_col_cnt LOOP
                              dbms_sql.define_column(
                                        l_cursor
                                      , i
                                      , l_buffer
                                      , 32767
                              );
                    END LOOP;

                    IF
                              p_query IS NOT NULL
                    THEN
                              l_rows := dbms_sql.execute(l_cursor);
                    END IF;

                    l_file := utl_file.fopen(
                              p_dir
                            , p_file
                            , 'w'
                            , 32767
                    );

  -- Output the column names.
                    FOR i IN 1..l_col_cnt LOOP
                              IF
                                        i > 1
                              THEN
                                        utl_file.put(
                                                  l_file
                                                , g_sep
                                        );
                              END IF;
                              utl_file.put(
                                        l_file
                                      , l_desc_tab(i).col_name
                              );
                    END LOOP;

                    utl_file.new_line(l_file);

  -- Output the data.
                    LOOP
                              EXIT WHEN
                                        dbms_sql.fetch_rows(l_cursor) = 0;
                              FOR i IN 1..l_col_cnt LOOP
                                        IF
                                                  i > 1
                                        THEN
                                                  utl_file.put(
                                                            l_file
                                                          , g_sep
                                                  );
                                        END IF;
                                        dbms_sql.column_value(
                                                  l_cursor
                                                , i
                                                , l_buffer
                                        );
                                        utl_file.put(
                                                  l_file
                                                , l_buffer
                                        );
                              END LOOP;

                              utl_file.new_line(l_file);
                    END LOOP;

                    utl_file.fclose(l_file);
                    dbms_sql.close_cursor(l_cursor);
          EXCEPTION
                    WHEN OTHERS THEN
                              IF
                                        utl_file.is_open(l_file)
                              THEN
                                        utl_file.fclose(l_file);
                              END IF;
                              IF
                                        dbms_sql.is_open(l_cursor)
                              THEN
                                        dbms_sql.close_cursor(l_cursor);
                              END IF;
                              dbms_output.put_line('ERROR: ' || dbms_utility.format_error_backtrace);
                              RAISE;
          END generate_all;

-- Alter separator from default.

          PROCEDURE set_separator ( p_sep   IN VARCHAR2 )
                    AS
          BEGIN
                    g_sep := p_sep;
          END set_separator;

END csv;
